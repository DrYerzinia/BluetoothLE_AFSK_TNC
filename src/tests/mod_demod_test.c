// modulator_test.c

#include <stdio.h>
#include <string.h>

#include <assert.h>

#include "../RFDuino_TNC/AFSK_Modulator.h"
#include "../RFDuino_TNC/AFSK_Demodulator.h"

const uint8_t ARISS_data[][255] = {
	{
		0x86, 0xa2, 0x40, 0x40, 0x40, 0x40, 0x60, 0xa4, 0xa6, 0x60, 0x92, 0xa6,
		0xa6, 0xe8, 0xa6, 0x8e, 0x82, 0xa8, 0x8a, 0x40, 0x61, 0x03, 0xf0, 0x3e,
		0x41, 0x52, 0x49, 0x53, 0x53, 0x20, 0x2d, 0x20, 0x49, 0x6e, 0x74, 0x65,
		0x72, 0x6e, 0x61, 0x74, 0x69, 0x6f, 0x6e, 0x61, 0x6c, 0x20, 0x53, 0x70,
		0x61, 0x63, 0x65, 0x20, 0x53, 0x74, 0x61, 0x74, 0x69, 0x6f, 0x6e, 0x20,
		0x28, 0x42, 0x42, 0x53, 0x2f, 0x41, 0x50, 0x52, 0x53, 0x20, 0x6f, 0x6e,
		0x29, 0x0d, 0x8f, 0x20, 0x0a
	}
};

const uint32_t ARISS_data_len[] = {76};
const uint16_t ARISS_count = 1;

const uint8_t ISS_pass_data[][255] = {
	{
		0x82, 0xa0, 0x8a, 0x8e, 0x60, 0x64, 0x60, 0x82, 0x86, 0x68, 0x82, 0xac,
		0x40, 0x60, 0xa4, 0xa6, 0x60, 0x92, 0xa6, 0xa6, 0xe9, 0x03, 0xf0, 0x3d,
		0x34, 0x32, 0x30, 0x36, 0x2e, 0x34, 0x35, 0x4e, 0x2f, 0x30, 0x38, 0x37,
		0x35, 0x34, 0x2e, 0x34, 0x30, 0x57, 0x2d, 0xdd, 0x84
	},
	{
		0x82, 0xa0, 0xa4, 0xa6, 0x40, 0x40, 0x60, 0xae, 0x84, 0x70, 0x9c, 0xaa,
		0xa8, 0x64, 0xa4, 0xa6, 0x60, 0x92, 0xa6, 0xa6, 0xe9, 0x03, 0xf0, 0x3d,
		0x33, 0x39, 0x30, 0x33, 0x2e, 0x38, 0x31, 0x4e, 0x2f, 0x30, 0x38, 0x34,
		0x31, 0x39, 0x2e, 0x31, 0x36, 0x57, 0x60, 0x44, 0x75, 0x66, 0x66, 0x79,
		0x20, 0x69, 0x6e, 0x20, 0x41, 0x6e, 0x64, 0x65, 0x72, 0x73, 0x6f, 0x6e,
		0x20, 0x54, 0x77, 0x70, 0x2e, 0x2c, 0x20, 0x4f, 0x48, 0x20, 0x45, 0x4d,
		0x37, 0x39, 0x20, 0x64, 0x75, 0x66, 0x66, 0x79, 0x40, 0x77, 0x62, 0x38,
		0x6e, 0x75, 0x74, 0x2e, 0x63, 0x6f, 0x6d, 0xf3, 0x13
	},
	{
		0xa8, 0xa6, 0x62, 0xa0, 0x62, 0xae, 0x60, 0x9c, 0x62, 0x92, 0x8a, 0x94,
		0x40, 0xfc, 0xa4, 0xa6, 0x60, 0x92, 0xa6, 0xa6, 0xe9, 0x03, 0xf0, 0x60,
		0x65, 0x46, 0x7b, 0x6c, 0x20, 0x2a, 0x75, 0x2f, 0x5d, 0x22, 0x35, 0x26,
		0x7d, 0x31, 0x38, 0x20, 0x57, 0x68, 0x65, 0x65, 0x6c, 0x20, 0x6d, 0x6f,
		0x62, 0x69, 0x6c, 0x65, 0x3d, 0x0d, 0x69, 0x8c
	},
	{
		0x82, 0xa0, 0xa4, 0xa6, 0x40, 0x40, 0x60, 0xae, 0x84, 0x70, 0x9c, 0xaa,
		0xa8, 0x64, 0xa4, 0xa6, 0x60, 0x92, 0xa6, 0xa6, 0xe9, 0x03, 0xf0, 0x3d,
		0x33, 0x39, 0x30, 0x33, 0x2e, 0x38, 0x31, 0x4e, 0x2f, 0x30, 0x38, 0x34,
		0x31, 0x39, 0x2e, 0x31, 0x36, 0x57, 0x60, 0x44, 0x75, 0x66, 0x66, 0x79,
		0x20, 0x69, 0x6e, 0x20, 0x41, 0x6e, 0x64, 0x65, 0x72, 0x73, 0x6f, 0x6e,
		0x20, 0x54, 0x77, 0x70, 0x2e, 0x2c, 0x20, 0x4f, 0x48, 0x20, 0x45, 0x4d,
		0x37, 0x39, 0x20, 0x64, 0x75, 0x66, 0x66, 0x79, 0x40, 0x77, 0x62, 0x38,
		0x6e, 0x75, 0x74, 0x2e, 0x63, 0x6f, 0x6d, 0xf3, 0x13
	},
	{
		0x82, 0xa0, 0xa4, 0xa6, 0x40, 0x40, 0x60, 0xae, 0x84, 0x70, 0x9c, 0xaa,
		0xa8, 0x64, 0xa4, 0xa6, 0x60, 0x92, 0xa6, 0xa6, 0xe9, 0x03, 0xf0, 0x3a,
		0x42, 0x4c, 0x4e, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x3a, 0x48, 0x65,
		0x6c, 0x6c, 0x6f, 0x20, 0x61, 0x6e, 0x64, 0x20, 0x47, 0x45, 0x20, 0x66,
		0x72, 0x6f, 0x6d, 0x20, 0x43, 0x69, 0x6e, 0x63, 0x69, 0x6e, 0x6e, 0x61,
		0x74, 0x69, 0x2c, 0x20, 0x4f, 0x48, 0xb9, 0x2f
	},
	{
		0x82, 0xa0, 0xa4, 0xa6, 0x40, 0x40, 0x60, 0xae, 0x84, 0x70, 0x9c, 0xaa,
		0xa8, 0x64, 0xa4, 0xa6, 0x60, 0x92, 0xa6, 0xa6, 0xe9, 0x03, 0xf0, 0x3d,
		0x33, 0x39, 0x30, 0x33, 0x2e, 0x38, 0x31, 0x4e, 0x2f, 0x30, 0x38, 0x34,
		0x31, 0x39, 0x2e, 0x31, 0x36, 0x57, 0x0d, 0x0a, 0x4f, 0x70, 0x3a, 0x20,
		0x44, 0x75, 0x66, 0x66, 0x79, 0x20, 0x69, 0x6e, 0x20, 0x43, 0x69, 0x6e,
		0x63, 0x69, 0x6e, 0x6e, 0x61, 0x74, 0x69, 0x2c, 0x20, 0x4f, 0x48, 0x0d,
		0x0a, 0x52, 0x69, 0x67, 0x3a, 0x20, 0x4b, 0x65, 0x6e, 0x77, 0x6f, 0x6f,
		0x64, 0x20, 0x44, 0x37, 0x31, 0x30, 0x0d, 0x0a, 0x41, 0x6e, 0x74, 0x3a,
		0x20, 0x52, 0x69, 0x6e, 0x67, 0x6f, 0x0d, 0x5a, 0x9a
	},
	{
		0x86, 0xa2, 0x40, 0x40, 0x40, 0x40, 0x60, 0xa4, 0xa6, 0x60, 0x92, 0xa6,
		0xa6, 0xe8, 0xa6, 0x8e, 0x82, 0xa8, 0x8a, 0x40, 0x61, 0x03, 0xf0, 0x3e,
		0x41, 0x52, 0x49, 0x53, 0x53, 0x20, 0x2d, 0x20, 0x49, 0x6e, 0x74, 0x65,
		0x72, 0x6e, 0x61, 0x74, 0x69, 0x6f, 0x6e, 0x61, 0x6c, 0x20, 0x53, 0x70,
		0x61, 0x63, 0x65, 0x20, 0x53, 0x74, 0x61, 0x74, 0x69, 0x6f, 0x6e, 0x20,
		0x28, 0x42, 0x42, 0x53, 0x2f, 0x41, 0x50, 0x52, 0x53, 0x20, 0x6f, 0x6e,
		0x29, 0x0d, 0x8f, 0x20, 0x0a
	}
};

const uint32_t ISS_pass_data_len[] = {45, 93, 56, 93, 68, 105, 76};
const uint16_t ISS_pass_count = 7;	

void test_file(const char * file_name, const uint8_t test_data[][255], const uint32_t *test_data_len, const uint16_t test_count){

	FILE * test_data_file;

	uint16_t packet_count = 0;
	uint8_t packet_data[256];
	packet_data[0] = 0;

	test_data_file = fopen(file_name, "r");

	while(!feof(test_data_file)){

		int8_t dat = fgetc(test_data_file);
		AFSK_Demodulator_proccess_byte(dat, packet_data); 

		if(packet_data[0] != 0){

			assert(packet_data[0] == test_data_len[packet_count]);
			assert(0 == memcmp(packet_data + 1, test_data[packet_count], test_data_len[packet_count]));
			packet_data[0] = 0;

			packet_count++;
			printf("Passed packet %d test\n", packet_count);

		}

	}

	assert(packet_count == test_count);

	fclose(test_data_file);

}

void test_modulator(const uint8_t test_data[][255], const uint32_t *test_data_len, const uint16_t test_count){

	uint16_t packet_count = 0;
	uint8_t packet_data[256];
	packet_data[0] = 0;

	uint16_t i;
	for(i = 0; i < test_count; i++){

		AFSK_Modulator_init(test_data[0], test_data_len[0], 1200, 1200, 2200, 25, 5);

		int16_t dat = 0;
		while(dat != 0x100){
			dat = AFSK_Modulator_next_sample();
			AFSK_Demodulator_proccess_byte((int8_t) dat/2, packet_data); 
			// Packets that are too loud will have there multiplys overflow so we need to divide
			// data from modulator so it will decode

			if(packet_data[0] != 0){

				assert(packet_data[0] == test_data_len[0]);
				assert(0 == memcmp(packet_data + 1, test_data[0], test_data_len[0]));

				packet_data[0] = 0;

				packet_count++;
				printf("Passed packet %d test\n", packet_count);

			}

		}
	}

	assert(packet_count == test_count);

}

void main(){

	AFSK_Demodulator_init(1200, 2200, 1200);

	test_file("data/ARISS_stat_packet_11025.raw", ARISS_data, ARISS_data_len, ARISS_count);
	printf("ARISS Demod Test passed\n");

	test_file("data/ISS_pass_11025.raw", ISS_pass_data, ISS_pass_data_len, ISS_pass_count);
	printf("ISS pass Demod Test passed\n");

	test_modulator(ARISS_data, ARISS_data_len, ARISS_count);
	printf("ARISS Modulator Test passed\n");

	test_modulator(ISS_pass_data, ISS_pass_data_len, ISS_pass_count);
	printf("ARISS Modulator Test passed\n");

}

